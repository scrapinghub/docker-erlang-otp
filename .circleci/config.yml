---
version: 2
jobs:
  build:
    environment:
      OTP_MAJOR_VERSION: "20"
    docker:
      - image: circleci/buildpack-deps:stretch
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run: |
          [ -d ~/official-images ] || git clone https://github.com/docker-library/official-images.git ~/official-images
          export DIR=$OTP_MAJOR_VERSION
          export VARIANT=slim
          export IMAGE_NAME="images.scrapinghub.com/crawlera/docker-erlang-otp/${DIR}/${CIRCLE_BRANCH}"
          export IMAGE_TAG="${CIRCLE_SHA1:0:7}"
          docker login -u $DOCKER_USER -p $DOCKER_PASS images.scrapinghub.com
          docker build --pull -t "$IMAGE_NAME:$IMAGE_TAG-$VARIANT" "$DIR/$VARIANT"
          ~/official-images/test/run.sh "$IMAGE_NAME:$IMAGE_TAG-$VARIANT"
          docker push "$IMAGE_NAME:$IMAGE_TAG-$VARIANT"
          if [ "${CIRCLE_BRANCH}" == "master" ]; then
            docker tag "$IMAGE_NAME:$IMAGE_TAG-$VARIANT" "$IMAGE_NAME:latest"
            docker push "$IMAGE_NAME:latest"
          fi
      - run: |
          [ -d ~/official-images ] || git clone https://github.com/docker-library/official-images.git ~/official-images
          export OTP_DIR=$OTP_MAJOR_VERSION
          export DIR=elixir
          export VARIANT=slim
          export IMAGE_NAME="images.scrapinghub.com/crawlera/docker-erlang-otp/${DIR}/${CIRCLE_BRANCH}"
          export OTP_NAME="images.scrapinghub.com/crawlera/docker-erlang-otp/${OTP_DIR}/${CIRCLE_BRANCH}"
          export IMAGE_TAG="${CIRCLE_SHA1:0:7}"
          docker login -u $DOCKER_USER -p $DOCKER_PASS images.scrapinghub.com
          docker build --pull -t "$IMAGE_NAME:$IMAGE_TAG-$VARIANT" --build-arg BASE_OTP="$OTP_NAME:$IMAGE_TAG" "$DIR/$VARIANT"
          ~/official-images/test/run.sh "$IMAGE_NAME:$IMAGE_TAG-$VARIANT"
          docker push "$IMAGE_NAME:$IMAGE_TAG-$VARIANT"
          if [ "${CIRCLE_BRANCH}" == "master" ]; then
            docker tag "$IMAGE_NAME:$IMAGE_TAG-$VARIANT" "$IMAGE_NAME:latest"
            docker push "$IMAGE_NAME:latest"
          fi
